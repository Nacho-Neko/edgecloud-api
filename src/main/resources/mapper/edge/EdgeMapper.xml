<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mikou.edgecloud.edge.infrastructure.persistence.mapper.EdgeMapper">

    <resultMap id="EdgeResultMap" type="com.mikou.edgecloud.edge.infrastructure.persistence.entity.EdgeEntity">
        <id property="id" column="id"/>
        <result property="edgeTag" column="edgeTag" javaType="java.util.UUID"/>
        <result property="name" column="name"/>
        <result property="regionId" column="regionId"/>
        <result property="status" column="status"/>
        <result property="features" column="features" typeHandler="com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler"/>
        <result property="createdAt" column="createdAt"/>
        <result property="updatedAt" column="updatedAt"/>
    </resultMap>

    <select id="selectPageWithRegion" resultMap="EdgeResultMap">
        SELECT
            e.id,
            e.edge_tag AS edgeTag,
            e.name,
            e.region_id AS regionId,
            e.status,
            e.features,
            e.created_at AS createdAt,
            e.updated_at AS updatedAt
        FROM edge e
        <if test="cityId != null">
            INNER JOIN edge_area city ON e.region_id = city.id
        </if>
        <if test="regionId != null">
            INNER JOIN edge_area state ON (
                <choose>
                    <when test="cityId != null">city.id</when>
                    <otherwise>e.region_id</otherwise>
                </choose>
            ) = state.id
        </if>
        <if test="countryId != null">
            INNER JOIN edge_area country ON (
                <choose>
                    <when test="regionId != null">state.parent_id</when>
                    <when test="cityId != null">
                        (SELECT parent_id FROM edge_area WHERE id = (SELECT parent_id FROM edge_area WHERE id = city.id))
                    </when>
                    <otherwise>e.region_id</otherwise>
                </choose>
            ) = country.id
        </if>
        <where>
            <if test="cityId != null">
                AND city.id = #{cityId}
            </if>
            <if test="regionId != null">
                AND state.id = #{regionId}
            </if>
            <if test="countryId != null">
                AND country.id = #{countryId}
            </if>
        </where>
    </select>

</mapper>
